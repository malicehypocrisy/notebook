# 一、亲缘关系基础

## &#9352;**Wright 亲缘关系定义：**

* *本质*：两个体遗传效应的相关性。
* 皮尔逊相关系数(两个变量之间的[协方差](https://baike.baidu.com/item/协方差/0?fromModule=lemma_inlink)和[标准差](https://baike.baidu.com/item/标准差/0?fromModule=lemma_inlink)的商)。
* 注意：==存在近交时，系谱亲缘关系不等于相关系数。==

## &#9353;**分子亲缘关系**

* **别名**：加性亲缘关系"（强调仅考虑基因加性效应)

* 本质是**标准化协方差**而非相关系数！

$$
a_{AB}=\frac{2 \cdot \operatorname{Cov}(G_A, G_B)}{\sigma_G^2}
\\
\sigma_G^2 \text{ 是群体遗传方差}相关概念
$$

## &#9354;相关概念

### &#9312;共祖系数$\theta_{ij}$

* 指从两个体 $i$ 和 $j$中各随机抽取一个等位基因时，==两者同源 (血统相同) 的概率==。
* 若为同一个体，则采用有放回抽样。
* **具有谱系继承性**

### &#9313;近交系数 $F_k$

* 个体 $k$ 中两个<u>等位基因同源的概率</u>。

* 若 $k$ 是 $i$ 和 $j$的后代，则 $F_k = \theta_{ij}$。另，$\theta_{kk} = (1 + F_k)/2$。

### &#9314;加性亲缘关系 

* (简称亲缘关系) 等于两倍共祖系数: $A_{ij} = 2 \theta_{ij}$。同理，$A_{kk} = 1 + F_k$。

### &#9315;两个体间遗传协方差为

$$
\text{Cov}(u_i, u_j) = 2 \theta_{ij} \sigma_u^2 = A_{ij} \sigma_u^2
$$

基础：所有亲缘度量的基准都是**假定无亲缘关系且携带不同 QTL 等位基因的奠基群体**。

**注意**：==亲缘关系恒为正数==，但利用标记或 QTL 信息时则不然。

## &#9355; 状态同一性(IBS)概率

* 定义：**从个体 $i$ 和 $j$中各随机抽取一个等位基因(不一定来源以同一祖先)时，两者完全相同的概率。**

* 符号：$f_{Mij}$

* 分子亲缘关系的转换($r_{Mij}$)

  * $$
    r_{Mij}=2 \cdot f_{Mij}
    $$

* 双等位基因的简化形式

$$
r_{Mij}=z_{i} z_{j}-z_{i}-z_{j}+2
\\
\text{当 $z_i$ 被编码为 $\{0,1,2\}$ 时}
$$

## &#9356;血统同一性(IBD)

$$
A_{ij}=\frac{r_{Mij}-2 p^{2}-2 q^{2}}{2 p q}
$$

由此可见，IBS相对于IBD存在高估偏差。
$$
(1-f_{\text{Mij}})=(1-\theta_{\text{ij}})\left(1-p^{2}-q^{2}\right)
$$

* 分子杂合度(即两个体的”非相似性”)等于**血统导致的非相似性与标记位点非相似性的乘积**。

## &#9357;个体间协方差

关键： **用QTL传递模拟构建“假设遗传值向量”**

### &#9312;操作流程

&#9332;**虚拟复制牛群系谱**：

* 在计算机中​**​重复模拟减数分裂过程​**​（如100万次），每次随机分配QTL（数量性状位点）等位基因。

&#9333;**生成动态遗传值**：

* 公牛ALTACEASAR在**第k次模拟**中获得遗传值：$G_k^A$
* 公牛BODRUM在**第k次模拟**中获得遗传值：$G_k^B$

&#9334;**构建数据向量：**
$$
\overrightarrow{G}^A = [G_1^A, G_2^A, ..., G_n^A], \quad \overrightarrow{G}^B = [G_1^B, G_2^B, ..., G_n^B]
$$

最终输出：
$$
\text{Cov}_{AB} = \frac{1}{n-1} \sum_{k=1}^n (G_k^A - \bar{G}^A)(G_k^B - \bar{G}^B)
$$

# 二、单 QTL位点的个体间亲缘关系

## &#9352;育种值

==表示为遗传值(**$za$**)偏离群体均值$\mu=2pa$的函数==
$$
u_i = z_i a - 2 p a = (z_i - 2 p) a
\\
u_j = z_j a - 2 p a = (z_j - 2 p) a
\\
\text{当 $z_i$ 被编码为(假设A为等位基因) $\{0,1,2\}$ 时}
$$

若QTL 效应服从方差$Var(a)=σ^2_a$的先验分布，且Hardy-Weinberg平衡下的遗传方差为$2pqσ^2_a$，则
$$
\text{Cov}(u_i, u_j)=(z_i-2 p)(z_j-2 p)\sigma_a^2
$$

### &#9312;采用中心化编码

$$
z^∗_i=z_i−2p，
\\
\text{Cov}(u_i, u_j)=z_i^*z_j^*\sigma_a^2
$$

### &#9313;加性亲缘关系

$$
r_{Qij}=\frac{\text{Cov}(u_i,u_j)}{\text{遗传方差}}=\frac{z_{i}^{*} z_{j}^{*} \sigma_{a}^{2} }{2 p q \sigma_{a}^{2}}=\frac{z_{i}^{*} z_{j}^{*}}{2 p q}
$$

## &#9353;中心化亲缘关系与IBS亲缘关系

$$
2(\mathbf{IBS}-I)=\mathbf{r_{Qij}}
$$

## &#9354;单QTL位点的近交系数

$$
F_i = r_{Qii} - 1
$$

# 三、多标记位点的个体间关联

## &#9352; VanRaden 首代基因组关系矩阵

### &#9312;个体育种值模型

$$
\mathbf{u=za}
$$

* $\mathbf{u}$:向量（所有个体的育种值）
* $\mathbf{z}$:矩阵（个体基因型编码，行=个体，列=标记）
* $\mathbf{a}$：向量（标记效应值）
* *意义*：个体的育种值是其所有标记遗传效应的线性组合。

### &#9313;**标记效应方差假设**

$$
Var(a)=\mathbf{D} = \begin{pmatrix}
\sigma_{a1}^2 & 0 & \ldots & 0 \\
0 & \sigma_{a2}^2 & \ldots & 0 \\
\ldots & \ldots & \ldots & \ldots \\
0 & 0 & \ldots & \sigma_{an}^2
\end{pmatrix}
$$

* 简化为$\mathbf{D=I}\sigma^2_{a0}$

### &#9314;育种值的方差-协方差矩阵

$$
Var(\mathbf{u})=\mathbf{ZZ^`}\sigma_{a0}^2
$$

注意：标量$Var(u)=E(u^2)-E(u)^2=\sigma^2_u$

在哈迪-温伯格平衡下群体中，可得到
$$
\sigma_u^2=2\sum{p_iq_i\sigma_{a0}^{2}}
$$

### &#9315;基因组关系矩阵

$$
\mathbf{G}=\frac{\mathbf{ZZ^`}}{2\sum{p_iq_i}}\tag{1}
$$

* 依据：==哈迪-温伯格平衡下群体加性遗传方差计算==
* *结果*：**`G` 矩阵元素成为无单位的亲缘关系系数**

- *G矩阵优势*：通过 **等位基因频率中心化调整**，使IBS数据更接近真实IBD

## &#9353;VanRaden第二基因组关系矩阵

核心：采用权重矩阵$\mathbf{D_w}$ 对标记进行**差异化加权**。

### &#9312;**基因组关系矩阵的定义**

$$
\mathbf{G=ZD_{w}Z}
\\
\text{其中    }
\mathbf{D_w} = \begin{pmatrix}
\frac{1}{n 2p_1 q_1} & 0 & \cdots & 0 \\
0 & \frac{1}{n2 p_2 q_2} & \cdots & 0 \\
\cdots & \cdots & \cdots & \cdots \\
0 & 0 & \cdots & \frac{1}{n2 p_n q_n}
\end{pmatrix}
$$

* 此处$n$表示标记数量

### &#9313;基因组关系矩阵

$$
\mathbf{G}=\frac{1}{n}\sum^{n}_{i=1}{\mathbf{G_i}}=\frac{1}{n}\sum^{n}_{i=1}{\frac{\mathbf{z_{i}z^`}}{2p_iq_i}}
$$

* 此时，$Var({\mathbf{u}})=\mathbf{ZDZ^`}$
* 依据：==哈迪-温伯格平衡下群体加性遗传方差计算==

$$
\mathbf{D} = \begin{pmatrix}
\frac{\sigma_u^2}{n 2p_1 q_1} & 0 & \cdots & 0 \\
0 & \frac{\sigma_u^2}{n2 p_2 q_2} & \cdots & 0 \\
\cdots & \cdots & \cdots & \cdots \\
0 & 0 & \cdots & \frac{\sigma_u^2}{n2 p_n q_n}
\end{pmatrix}
$$

### &#9314;核心争议点

* **对低频等位基因过度敏感**：稀有等位基因（如测序发现的低频变异）被赋予过高权重。
* 对于单态等位基因(p=0or1)，矩阵将无定义。
* 每个标记对整体$\mathbf{G}$的方差贡献是相同的，每个标记对遗传方差 $\sigma_u^2$ 的==贡献==恒为 $\frac{\sigma_u^2}{n}$ （与其频率无关）

## &#9354;矩阵$\mathbf{G}$

* 构建矩阵$\mathbf{z}$：==应使用基础群体等位基因频率==。
* 分母使用**当前等位基因频率**：若系谱隔代过多会导致遗传方差衰减

### &#9312;特性

以下特性均基于：`公式1`

* $\mathbf{u}$的平均值为0，因为$\mathbf{Z}$已进行中心化处理。
* $\mathbf{G}$的均值为零
* $\mathbf{G}$矩阵对角线元素的平均值为 **1**，无近交且需满足哈迪-温伯格平衡
* 若存在近交，则$\mathbf{G}$矩阵对角线元素的平均值为 **$1+F$**，需满足哈迪-温伯格平衡
* $\mathbf{G}$矩阵非对角线元素的平均值近似为 **0**，无近交且需满足哈迪-温伯格平衡玉连锁平衡

## &#9355; 加权基因组关系矩阵

* 贝叶斯回归是基因组选择的一种方法。
* 核心在于认为不同标记可能具有不同方差。

$$
Var(\mathbf{u})=\mathbf{ZD_{w}Z^`}\sigma_u^2
$$

**权重估算方法多样：**

- **贝叶斯方法 (Zhang, Legarra):** 效果好，计算开销大。
- **REML策略 (Shen):** 基于REML思想，可能高效。
- **简单算法 (Sun):** 快速但有严重偏差，不推荐。
- **VanRaden非线性A：** 迭代法更新权重，有其适用场景（尤其在育种选择评估中）

# 四、 作为实际亲缘关系估计量的基因组关系

## &#9352;矛盾点

* 在无穷小模型中，所有位点上**两个全同胞恰好共享一半基因组**。

* 但对于真实染色体则不然：染色体往往共同传递，==两个半同胞可能继承完全不同的基因片段==。

### &#9312;**系谱亲缘关系及其前提假设**

- `系谱亲缘关系假设存在无限多未连锁基因的无穷小模型。`
- 两个核心假设点：
  - **无限多位点：** 控制性状的基因位点数量是无限多的。
  - **未连锁/无连锁：** 这些基因位点在遗传时是相互独立的（不存在连锁现象）。

### &#9313;**实际亲缘关系的微观（单个位点）层面表现**

* `在单个位点上，两个全同胞可能共享一个、两个或零个等位基因。`

## &#9353;现实亲缘关系$R_{ij}$

* 定义：个体 $i$与 $j$间**实际共享的基因组片段比例**，是一个随机变量（受减数分裂染色体随机分配影响）

* 前提：**假设存在无亲缘关系的基础群体，此时即为血统同源关系**

$$
E(R_{ij})=A_{ij}
$$

缺陷：这些偏差呈偏态分布，且低亲缘度个体的偏差/期望比值较高。这意味着两个三级表亲可能实际上 共享任何等位基因。

### &#9312;公式推导

$$
\hat{R}_{ij}=\frac{Cov(z_i,z_j)}{2pq}
$$

注意：

* 这里的$2pq$采用 $\frac{2}{m}\sum{p_i}{q_i}$，这里$m$为标记物的数量
* 推导出==公式1==

### &#9313;公式1的特性（VanRaden基因组亲缘关系）

* ==既是实际亲缘关系的估计量，也是利用标记物推断亲缘关系的估计方法==
* 基因组亲缘关系同时关联着标记物效应与亲缘关系。

$$
E(\mathbf{G})=\mathbf{A}
$$

## &#9354;其他 (基因组)亲缘关系估计方法

可基于IBS系数或”相似性系数”$G_{IBS}$构建$r_{Mij}$亲缘关系矩阵。
$$
\mathbf{G}_{IBS}=r_{Mij}=\frac{1}{n}\sum{^n_{m=1}2\frac{\sum{^2_{k=1}}\sum{^2_{k=1}{I_{kl}}}}{4}}
$$
其中：

* $I_{kl}$衡量个体$i$的等位基因$k$与个体$j$的等位基因$l$的匹配度**(取值为1或0**)，单一位点的匹配度在**k**个位点上取均值。
* 优势:$G_{IBS}$中的元素均为**概率值**(与其他G类型不同)

$$
r_{Mij}=\mathbf{G}_{IBS}=\frac{1}{m}(\mathbf{Z_{101}Z^`_{101}})+\mathbf{11^`}
$$

### &#9312;假设所有频率$p_i=0.5$

VanRaden 的 $\mathbf{G}$通过$Z_{101}$ (编码为{−1,0,1})构建，并除以标记数量$m$的$2p{i}q{i} =m/2$。
$$
\mathbf{G}_{IBS}=\frac{1}{m}\mathbf{G_{0.5}}+\mathbf{11^`}
$$

## &#9354;基因组近交系数

定义：**对于个体$i$，其基因组的近交系数可定义为$G_{ii}-1$**

若谱系质量良好(无缺失亲本)且$G$采用的等位基因频率接近群体实际值，**基因组与谱系近交的相关系数可达>0.5**。
$$
p(u_2)=N(0,G^*\sigma_u^2)
\\
\text{其中，}u_2\text{是基因型已知的动物}
\\
\mathbf{G}^*=(\mathbf{G}+\mathbf{11}^`)\sigma_u^2
$$

### &#9312;矩量法求解

* 通过对齐系谱与基因组的**群体平均方差**，定量计算补偿常数 *a*。

$$
a=\overline{\mathbf{A}}_{22}-\overline{\mathbf{G}}
$$

* 在哈达温伯格平衡下，$\overline{\mathbf{G}}=0$，$a=\overline{\mathbf{A}}_{22}$

## &#9355;遗传方差的兼容性

注意点：对于**公式1**，若采用当前群体的基因频率则会低估$2\sum{p_iq_i}$，故寻求校正方案
$$
\mathbf{G^*}=b\mathbf{G}
\\
\text{其中，}b=\text{当前除以基础群}
$$
在系谱关系与基因组关系下推导：
$$
b=\frac{1+\overline{F}_p-\overline{\mathbf{A}}_{22}}{1+\overline{F}_g-\overline{\mathbf{G}}}
\\
\text{其中}\overline{F}_p \text{表示平均谱系近交系数，}\overline{F}_g\text{表示平均基因组近交系数}
$$

* 在哈达温伯格平衡下，$\overline{\mathbf{G}}=0$，$\overline{F}_g=0$（平均对角线值为1）
* 若发生随机交配，$\overline{F}_p =\frac{\overline{\mathbf{G}}}{2}$，故$b=1-\frac{a}{2}$

## &#9356;遗传基础与方差的兼容性

校准公式：
$$
\mathbf{G^*}=a+b\mathbf{G}
$$

### &#9312; **Christensen 法（通用场景）**

$$
\begin{cases}
\dfrac{\operatorname{tr}(a + b \mathrm{G})}{m} = \dfrac{\operatorname{tr}(\mathrm{A_{22}})}{m} & \text{校准对角线均值} \\
a + b \mathrm{G} = \overline{\mathrm{A_{22}}} & \text{校准整体均值}
\end{cases}
$$

解：$b\approx1-\frac{a}{2}$

# 五、$\mathbf{G}$矩阵的奇异性

获得满秩的$\mathbf{G}$矩阵的方法

## &#9352;修正

$$
\mathbf{G}_w=(1-\alpha)\mathbf{G}+\alpha\mathbf{I}
\\
\text{其中，}\alpha为较小值，通常取0.01或0.05
$$

## &#9353;混合基因组与系谱关系

$$
\mathbf{G}_w=(1-\alpha)\mathbf{G}+\alpha\mathbf{A}_{22}
$$

## &#9354;在G中包含剩余多基因效应

**最简便的方法**：纳入$\mathbf{G}_w=(1-\alpha)\mathbf{G}+\alpha\mathbf{A}_{22}$构建修正矩阵$\mathbf{G}_w$的$\mathbf{G}$矩阵
