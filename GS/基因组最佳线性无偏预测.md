# 一、单性状动物基因模型

构建线性模型：
$$
\mathbf{y=Xb+Wu+e}
$$
其中，$\mathbf{W}$为表型与个体的关联矩阵，则$Var(u)=G\sigma^2_u,Var(e)=R$
$$
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{X}' \mathrm{R}^{-1} \mathrm{W} \\
\mathrm{W}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{W}' \mathrm{R}^{-1} \mathrm{W} + \mathrm{G}^{-1} \sigma_u^{-2}
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathrm{b}} \\
\widehat{\mathrm{u}}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{y} \\
\mathrm{W}' \mathrm{R}^{-1} \mathrm{y}
\end{pmatrix}
$$
若 $\mathrm{R} = \mathrm{I} \sigma_e^2$，则方差组分可分解，方程转化为:
$$
\begin{pmatrix}
\mathrm{X}' \mathrm{X} & \mathrm{X}' \mathrm{W} \\
\mathrm{W}' \mathrm{X} & \mathrm{W}' \mathrm{W} + \mathrm{I} \lambda
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathrm{b}} \\
\widehat{\mathrm{u}}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{X}' \mathrm{y} \\
\mathrm{W}' \mathrm{y}
\end{pmatrix}
$$
其中 $\lambda = \sigma_e^2 / \sigma_u^2$。

# 二、多性状动物基因模型

$$
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{X}' \mathrm{R}^{-1} \mathrm{W} \\
\mathrm{W}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{W}' \mathrm{R}^{-1} \mathrm{W} + \mathrm{G}^{-1} \otimes\mathrm{G}^{-1}_{0}
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathrm{b}} \\
\widehat{\mathrm{u}}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{y} \\
\mathrm{W}' \mathrm{R}^{-1} \mathrm{y}
\end{pmatrix}
$$

其中$\mathbf{G}_0$是性状间遗传协方差矩阵，通常表现为$\mathbf{R}=\mathbf{I}\otimes\mathbf{R_0}$，这里$\mathbf{R_0}$代表残差协方差矩阵

## &#9352;可靠性

$$
\text{Rel}_i = 1 - \frac{C^{\text{ii}}}{G_{\text{ii}} \sigma_u^2}
$$

其中，$C^{ii}$是混合方程方程第一形式(即显式包含$σ^2_u$)逆矩阵的$i,i$元素，可靠性会受到基因编码的影响

近期研究建议：**将基础群体作为额外个体纳入，可自动将所有可靠性置于同 一尺度**

## &#9353;奇异阵$\mathbf{G}$下GBLUP

### &#9312; **原始形式（直接扩展标准方程）**

$$
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{X}' \mathrm{R}^{-1} \mathrm{W} \\
G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{X} & G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{W} + \mathrm{I}
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathrm{b}} \\
\widehat{\mathrm{u}}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{y} \\
G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{y}
\end{pmatrix}
$$

* 在右下角子阵加$\mathbf{I}$，强制可逆，导致**估计结果略有偏差**

&#9313; **对称形式（引入辅助向量 $\alpha$）**
$$
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{X} & \mathrm{X}' \mathrm{R}^{-1} \mathrm{W} G \sigma_u^2 \\
G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{X} & G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{W} G \sigma_u^2 + G \sigma_u^2
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathrm{b}} \\
\widehat{\alpha}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{X}' \mathrm{R}^{-1} \mathrm{y} \\
G \sigma_u^2 \mathrm{W}' \mathrm{R}^{-1} \mathrm{y}
\end{pmatrix}
$$
其中，$\hat{u}=\mathbf{G}\sigma{_u^2}\hat{\alpha}$

## &#9354;从 GBLUP到标记效应估计

- **理论基础**：

  在严格一致条件下（相同基因型矩阵 `Z`、等位基因频率 `p, q`、方差假设等），**GBLUP**（基于基因组关系矩阵 `G`的BLUP方法）与**BLUP-SNP**（直接估计标记效应 `a`的方法）的估计结果**在数学上等价**。

$$
\text{Var}
\begin{pmatrix}
\mathrm{u} \\
\mathrm{a}
\end{pmatrix}
=
\begin{pmatrix}
\mathrm{Z D Z'} & \mathrm{Z D} \\
\mathrm{D Z'} & \mathrm{D}
\end{pmatrix}
\\
\text{其中，}\mathbf{u=Za},Var(a)=D=\frac{\mathbf{I}\sigma_u^2}{2\sum{p_iq_i}}
$$

假设多元正态下，$p(\mathbf{u|a})=N(\mathbf{Za},0)$
$$
\widehat{\mathrm{u}} \mid \widehat{\mathrm{a}} = E \left( \mathrm{u} \mid \mathrm{a} = \widehat{\mathrm{a}} \right) = \mathrm{Z}' \widehat{\mathrm{a}}
$$
**反向推断**（育种值 → 标记效应）是**多解性问题**：同一个育种值 **u**可能对应多组标记效应 。

$$
p(\mathbf{a|u})=N(\mathbf{DZ^`(ZDZ^`)^{-1}u,D-DZ^`(ZDZ^`)^{-1}ZD})
$$

* 对于$(\mathbf{ZDZ^`}=G\sigma_u^2)$或$\mathbf{D=I\sigma_u^2/2\sum{p_{i}q_i}}$==得到的结果不一样==
* $\mathbf{D-DZ^`(ZDZ^`)^{-1}ZD}$可能是半正定矩阵（**不可逆**）

## &#9355;矩阵$\mathbf{G}$经过调谐

$$
\begin{align}
\mathbf{G^{tuned}}&=(1-\alpha)\mathbf{G^*}+\alpha\mathbf{A_{22}}
\\
&=(1-\alpha)(\mathbf{11^`}a+b\mathbf{G})+\alpha\mathbf{A_{22}}
\\
&= (1-\alpha)(\mathbf{11^`}a+b\mathbf{ZDZ^`})+\alpha\mathbf{A_{22}}
\end{align}
$$

其中:

* 系数$b$考虑遗传漂变导致的方差缩小。
* 系数$\alpha$表示分配给（系谱）剩余多基因效应的遗传方差部分。
* 系数$a$用于添加额外的”平均亲缘关系”。

$$
\begin{align}
Var(\mathbf{u})
& =Var(\mathbf{u}_p+\mathbf{u}^*_m+1\mu)
\\
&=\mathbf{A}_{22}\sigma_u^2\alpha+b\mathbf{ZDZ^`}(1-\alpha)+a(1-\alpha)\sigma_u^2
\\
& = \mathbf{G}^{tuned}
\end{align}
$$

其中：

* $\mathbf{u}_p$为“系谱”育种值
* $\mathbf{u}_m$为转换到系谱尺度的标记育种值
* $\mathbf{u}_m^*$为转换到基因组尺度的标记育种值
* $\mathbf{D}$缩减到$Var(\mathbf{a})=b(1-\alpha)\mathbf{D}$

$\mathbf{D=I}\sigma_u^2/2\sum{p_iq_i}$，让$\mathbf{ZZ^`}\frac{1}{2\sum{p_iq_i}}=\mathbf{G}^{untuned}，同时\mathbf{G}^{tuned}=(1-\alpha)(\mathbf{11^`a+b\mathbf{ZZ^`}}\frac{1}{2\sum{p_iq_i}})+\alpha\mathbf{A_{22}}$
$$
\text{Var}
\begin{pmatrix}
\mu \\
\mathbf{u}_p \\
\mathbf{u}_m^* \\
\mathbf{u} \\
\mathbf{a}
\end{pmatrix}
=
\begin{pmatrix}
a(1 - \alpha) & 0 & 0 & a(1 - \alpha)\mathbf{1}' & 0 \\
0 & \mathbf{A}_{22}\alpha & 0 & \mathbf{A}_{22}\alpha & 0 \\
0 & 0 & b(1 - \alpha)\mathbf{G}_{\text{untuned}} & b(1 - \alpha)\mathbf{G}_{\text{untuned}} & b(1 - \alpha)\mathbf{Z} \frac{1}{2 \Sigma p_i q_i} \\
a(1 - \alpha)\mathbf{1} & \mathbf{A}_{22}\alpha & b(1 - \alpha)\mathbf{G}_{\text{untuned}} & \mathbf{G}_{\text{tuned}} & b(1 - \alpha)\mathbf{Z} \frac{1}{2 \Sigma p_i q_i} \\
0 & 0 & b(1 - \alpha)\mathbf{Z}' \frac{1}{2 \Sigma p_i q_i} & b(1 - \alpha)\mathbf{Z}' \frac{1}{2 \Sigma p_i q_i} & b(1 - \alpha)\mathbf{I} \frac{1}{2 \Sigma p_i q_i}
\end{pmatrix}
\sigma_u^2
$$

### &#9312;反推基因组效应

$$
\text{方法一：}\hat{\mathbf{u}}^*_m|\hat{\mathbf{u}}=b(1-\alpha)\mathbf{G}^{untuned}\mathbf{G}^{tuned-1}\hat{\mathbf{u}}
\\
\text{方法二：}
\text{SNP效应：}\mathbf{\hat{a}}|\mathbf{\hat{u}}=b(1-\alpha)\mathbf{Z^`}\frac{1}{2\sum{p_iq_i}}\mathbf{G}^{tuned-1}\mathbf{\hat{u}}
\\
\mathbf{\hat{u}^*_m}|\mathbf{\hat{a}}=\mathbf{Z\hat{a}}
$$

则，$\mathbf{\hat{u}}_m=\hat{\mu}+\mathbf{\hat{u}_m^*}$

### &#9313;间接预测

* 基因分型后获得基因型矩阵$\mathbf{Z}_{new}$，使用与原始GBLUP或ssGBLUP相同的等位基因频率进行中心化处理。
* 新生动物的间接预测包含两个部分：$\mathbf{u=u_m+u_p}$

$$
\mathbf{\hat{u}}_m=\hat{\mu}+\mathbf{\hat{u}}^*_m=\hat{\mu}+\mathbf{Z}_{new}\mathbf{\hat{a}}
\\
\text{间接预测的系谱部分必须从父母系谱部分的亲本均值获取：}
\hat{u}_{p,i}=0.5(\hat{u}_{p,sire(i)}+\hat{u}_{p,dam(i)})
$$

### &#9314;间接预测的可靠性

* $Rel_{base_pedigree}=1-\frac{PEV(\hat{u}_m)}{Var(u_m)}=\frac{Var(\hat{u}_m)}{Var(u_m)}$
* $Rel_{base_genomic}=1-\frac{PEV(\hat{u}_m^*)}{Var(u_m^*)}=\frac{Var(\hat{u}_m^*)}{Var(u_m^*)}$

$$
\text{描述新动物与旧动物的接近程度}\mathbf{G}_{old,new}^{untuned}=\frac{\mathbf{ZZ^`_{new}}}{2\sum{p_i,q_i}}
$$

### &#9315;基于GBLUP的标记效应的贝叶斯分布

$$
\text{前提：}p(\mathbf{u|y})=N(\hat{\mathbf{u}},\mathbf{C}^{uu})
\\
Var(\hat{\mathbf{a}}|\mathbf{y})=Var(\mathbf{DZ^`(ZDZ^`)^{-1}(u-\hat{u})})
\\
=\mathbf{DZ^`(ZDZ^`)^{-1}C^{uu}(ZDZ^`)^{-1}ZD}
\\
\text{噪音: }Var(\mathbf{a-\hat{a}|y})=\mathbf{D-DZ^`(ZDZ^`)^{-1}ZD}
\\
\text{则，}Var(\mathbf{a|y})=\mathbf{D-DZ^`(ZDZ^`)^{-1}ZD}+\mathbf{DZ^`(ZDZ^`)^{-1}C^{uu}(ZDZ^`)^{-1}ZD}
$$

代入$\mathbf{ZDZ^`}=\mathbf{G}\sigma_u^2$，整理得到：
$$
\text{Var}(\mathbf{a} \mid \mathbf{y}) = \mathrm{D} - \mathrm{D} \mathrm{Z}' \mathrm{G}^{-1} \sigma_u^{-2} \left( \mathrm{G} \sigma_u^2 - \mathrm{C}^{\mathrm{uu}} \right) \mathrm{G}^{-1} \sigma_u^{-2} \mathrm{Z} \mathrm{D}
$$

* 第一项是标记效应的先验方差$\mathbf{D}$
* 第二项是数据带来的厚颜不确定性缩减。

### &#9316;GBLUP中标记效应的频率学派分布

$$
Var(\hat{\mathbf{a}})=Var(\mathbf{a})-Var(\mathbf{a|y})
$$

# 三、GBLUP中复杂问题

**伪数据**：非常规表型，具有异质性方差，但都附带可靠性度量。

异质性可通过残差协方差矩阵$\mathbf{R}$来建模
$$
\mathrm{R} =
\begin{pmatrix}
1/w_1 & 0 & 0 \\
0 & 1/w_2 & 0 \\
0 & 0 & \ddots
\end{pmatrix}
\sigma_e^2
$$

* 权重越大意味着残方差越小
