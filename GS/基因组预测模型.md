# 一、基因组预测模型

* 若相邻SNP高度相关，则其间QTL理论上也强相关。
* SNP数量超过基因型检测个体数量，导致“小$n$大$p$问题”。解决方案：**假设SNP效应为随机变量**。

## &#9352;标记选择困境

### &#9312;检验效能不足

* 微弱效应难以被检测。

### &#9313;比维斯效应

在进行QTL定位时，需要**通过检验判定QTL位置**，该检验依赖于QTL效应估计值。

* $$
  \text{estimated effect =real effect + “estimation noise”}
  $$
  
* **选择显著关联位点进行分析**，导致QTL效应被高估——尤其对小效应而言。

## &#9353;标记效应的贝叶斯估计

> [!NOTE]
>
> **标记效应可视为随机过程的结果，因其源于连锁不平衡的随机积累、基因等位基因的随机生成等**



* 在概率论中，任意随机变量 $Z$的条件期望定义为：

$$
E(Z \mid Y = y) = \int z \cdot p(z \mid y) dz
$$

### &#9312;标记效应的后验均值：

$$
\widehat{\mathbf{a}}=E(\mathbf{a}\mid y)=\frac{\int \mathbf{a} p(y\mid \mathbf{a}) p(\mathbf{a}) d \mathbf{a}}{\int p(y\mid \mathbf{a}) p(\mathbf{a}) d \mathbf{a}}
\\
\text{其中，}\mathbf{a}\text{标记效应，}\mathbf{y}\text{为观测数据}
$$
### &#9313;似然函数

$$
p(\mathbf{y} \mid \mathbf{a}) = MVN(\mathbf{Xb} + \mathbf{Za}, \mathbf{R})
$$

### &#9314;正则化估计量的最优预测

$$
\begin{cases}
\text{似然函数}\\
\text{正则化函数}\rightarrow\text{防止估计量“偏离过远”}
\end{cases}
$$

# 二、基因组预测流程

## **&#9352;在参考群体中准备数据**

### &#9312;**收集基因型数据**

* 获取参考群体（已知表型的个体）中所有标记（如SNP位点）的基因型矩阵$\mathbf{Z_r}$
  $$
  \mathbf{Z}_r\text{是} n(\text{个体数})×m(\text{标记数}) \text{矩阵}
  $$

### &#9313;**收集表型数据**

* 测量参考群体的表型值 **$\mathbf{y}$**。

## &#9353;估计标记效应$\mathbf{a}$

### &#9312;**构建统计模型**

$$
\mathbf{y}=\mathbf{1μ}+\mathbf{Z_{r}a}+\mathbf{e}
$$

### &#9313;**贝叶斯方法优化估计**

- 采用**贝叶斯统计模型**估计**a**的后验分布，利用先验信息提高小效应估计的稳定性。
- 输出结果为$\mathbf{a}$的最优估计值 $\hat{\mathbf{a}}$。

### &#9314;在候选群体中预测育种值

- **收集候选群体基因型**：获取育种候选群体（未知表型的个体）的基因型矩阵 $\mathbf{Z_c}$(格式同$\mathbf{Z_r}$）。
- **计算基因组育种值**（GEBV）：

$$
\hat{\mathbf{u}}_c=\mathbf{Z_c}\hat{\mathbf{a}}
$$

# 三、SNP-BLUP

## &#9352;等位基因编码

| 基因型 | 101编码 | 012编码 | 中心化编码      |
| ------ | ------- | ------- | --------------- |
| aa     | $-a_i$  | $0$     | $-2p_{i}a_i$    |
| Aa     | $0$     | $a_i$   | $(1-2p_{i})a_i$ |
| AA     | $a_i$   | $2a_i$  | $(2-2p_{i})a_i$ |

* 以**A**为参考等位基因的$i$位点标记效应加性编码。

## &#9353;先验信息对标记效应估计的影响

* 在重复实验中，**$\sigma^2_a$取较小值可使均值误差最小化**。

## &#9354;标记解释的遗传方差

* 单个标记解释的方差为$2pqa_i^{2}$，
* 具有==中等频率的标记将解释大部分遗传变异==，这是忽略低等位基因频率标记的原因之一。

## &#9355;标记解释的总遗传方差

$$
\sigma^2_u=Var(u)=2\sum{^n_ip_iq_ia_i^2}
\\
\text{假设所有标记的先验方差相等：}\sigma_{a0}^2 = \frac{\sigma_u^2}{2 \sum\limits_i^{nsnp} p_i q_i}\tag{1}
$$

* $2 \sum\limits_i^{nsnp} p_i q_i\hat{a}^2_i$会**低估**总遗传方差。

## &#9357;SNP-BLUP

$$
\mathbf{u}=\mathbf{Xb}+\mathbf{Za}+\mathbf{e}
\\
\text{其中，}\mathbf{a}\text{为标记效应}
\\
p(\mathbf{a}) = MVN(0, \mathbf{D}) \quad ; \quad \text{Var}(\mathbf{a}) = \mathbf{D} = \mathbf{I} \sigma_{a0}^2
$$

* 该模型用于**标记效应估计**。
* 假设标记间**相互独立**。

### &#9312;MME

* 多数情况下，标记效应通过吉布斯采样估计，但也存在闭式解。

$$
\begin{pmatrix}
\mathbf{X}'\mathbf{R}^{-1}\mathbf{X} & \mathbf{X}'\mathbf{R}^{-1}\mathbf{Z} \\
\mathbf{Z}'\mathbf{R}^{-1}\mathbf{X} & \mathbf{Z}'\mathbf{R}^{-1}\mathbf{Z} + \mathbf{D}^{-1}
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathbf{b}} \\
\widehat{\mathbf{a}}
\end{pmatrix}
=
\begin{pmatrix}
\mathbf{X}'\mathbf{R}^{-1}\mathbf{y} \\
\mathbf{Z}'\mathbf{R}^{-1}\mathbf{y}
\end{pmatrix}
$$

* 若 $\text{Var}(\mathbf{a}) = \mathbf{D} = \mathbf{I} \sigma_{a0}^2;\text{Var}(\mathbf{e}) = \mathbf{R} = \mathbf{I} \sigma_e^2，$则可简化为：

$$
\begin{pmatrix}
\mathbf{X}'\mathbf{X} & \mathbf{X}'\mathbf{Z} \\
\mathbf{Z}'\mathbf{X} & \mathbf{Z}'\mathbf{Z} + \mathbf{I} \lambda
\end{pmatrix}
\begin{pmatrix}
\widehat{\mathbf{b}} \\
\widehat{\mathbf{a}}
\end{pmatrix}
=
\begin{pmatrix}
\mathbf{X}'\mathbf{y} \\
\mathbf{Z}'\mathbf{y}
\end{pmatrix}
$$

* 维度=$(固定效应数+标记数)^2$,与个体数量无关
* $\mathbf{Z^{T}Z}$完全稠密且非稀疏

$$
\lambda=\frac{\sigma_{e}^2}{\sigma_{ao}^2}&
lhs\begin{pmatrix}
\mathbf{\hat{b}} \\
\mathbf{\hat{a}}
\end{pmatrix}=rhs
\\
\text{多性状协方差：}\mathbf{R} = \mathbf{I} \otimes \mathbf{R}_0 &\quad \mathbf{D} = \mathbf{I} \otimes \mathbf{S}_{a0}
$$

### &#9332;方差组分设置

* 混合方程假设已知：$\sigma_a^2$ 与 $\sigma_e^2$。

* 通过`[公式1]`求标记方差，其中 $\sigma_u^2$ 来自早期系谱研究，$p$来自遗传方差估计的群体。
* 残差方差参考既往研究数据。

### &#9333;标记效应求解

#### &#9372;PCG（预处理共轭梯度法）

$$
\left( \begin{matrix} \mathbf{X'X} & \mathbf{X'Z} \\ \mathbf{Z'X} & \mathbf{Z'Z} + \mathbf{I}\lambda \end{matrix} \right) \left( \begin{matrix} \widehat{\mathbf{b}}^l \\ \widehat{\mathbf{a}}^l \end{matrix} \right)  =  \left( \begin{matrix} \mathbf{X'} \\ \mathbf{Z'} \end{matrix} \right) \left( \left( \begin{matrix} \mathbf{X} & \mathbf{Z} \end{matrix} \right) \left( \begin{matrix} \widehat{\mathbf{b}}^l \\ \widehat{\mathbf{a}}^l \end{matrix} \right) \right)  +  \left( \begin{matrix} \mathbf{0} \\ \mathbf{I}\lambda \widehat{\mathbf{a}}^l \end{matrix} \right)
$$

* <u>采用通用求解器并通过连续计算向量积</u>。

#### &#9373;高斯—赛德残差更新法

$$
\begin{aligned}
(\mathbf{z}_i' \mathbf{z}_i + \lambda) \widehat{a}_i^{l+1} &= \mathbf{z}_i' \bigg( \mathbf{y} - \mathbf{X} \widehat{\mathbf{b}} - \mathbf{Z} \widehat{\mathbf{a}} + \mathbf{z}_i \widehat{a}_i^l \bigg ) \\
\text{故方程组为：} \quad (\mathbf{z}_i' \mathbf{z}_i + \lambda) \widehat{a}_i^{l+1} &= \mathbf{z}_i' \big( \widehat{\mathbf{e}}^l + \mathbf{z}_i \widehat{a}_i^l \big) = \mathbf{z}_i' \widehat{\mathbf{e}}^l + \mathbf{z}_i' \mathbf{z}_i \widehat{a}_i^l \\
\text{每次标记效应更新后需用下式修正误差项：} \quad \widehat{\mathbf{e}}^{l+1} &= \widehat{\mathbf{e}}^l - \mathbf{z}_i \big( \widehat{a}_i^{l+1} - \widehat{a}_i^l \big)
\end{aligned}
$$

* **使用最小二乘估计初始化`$\hat{b}$`（截距项）是必要的**

# 四、贝叶斯回归

## &#9352;BayesC($P_i=0$)

* 特点：**不直接迭代求解，先采样解向量（在给定方差下，随机抽样标记效应），再采样标记方差（更新遗传方差的后验分布）**。

### &#9312;方法本质

* 通过贝叶斯统计推断遗传方差组分（$\sigma^2_a$和$\sigma_e^2$）
* 设定标记效应概率为零（$p_i = 0$），假设所有标记对性状都有贡献。

### &#9313;先验分布公式

$$
E(\sigma^2_e|S_{e}, \nu_e)= \frac{S^2_a}{\nu_e}
\\
E(\sigma^2_a|S_{a}, \nu_a)= \frac{S^2_a}{\nu_a}
$$

- $S^2$：尺度参数（决定先验期望）
- $\nu$：自由度（决定先验强度），实践中常用值为`4`。
- $\chi_\nu^2$：卡方分布抽样

### &#9314;采用先前估计值并设定：

$$
S_{e}^{2}=\sigma_{e}^{2} \nu_{e}
\\
S_{a}=\sigma_{a 0}^{2} \nu_{a} ; \sigma_{a 0}^{2}=\frac{\sigma_{u}^{2}}{2\sum_{i}^{\text{nsnp}} p_{i} q_{i}}
$$

## &#9353;BayesA

* 前提：假设**存在标记方差的先验信息**，如$\sigma^2_{a0}$，作为$\sigma^2_{ai}$的先验信息

$$
p\left(a_{i} \mid \sigma_{a 0}^{2}, \nu_{a}\right)=\sigma_{a 0} t\left(0, \nu_{a}\right)
$$
特点：**该分布具有”厚尾”特性，意味着大标记效应在先验中并非小概率事件。**

$$
p\left(a_{i} \mid \sigma_{a i}^{2}\right)=N\left(0, \sigma_{a i}^{2}\right)
\\
p\left(\sigma_{a i}^{2} \mid S_{a}, \nu_{a}\right)=S_{a} \chi_{\nu_{a}}^{-2}
\\
S^2_{a}=\sigma^2_{a0}\nu_{a0}
$$

* 若 $(X \sim \chi_\nu^2)$，则 $\sigma^2 = S^2 / X$服从逆卡方分布
* 期望：$E(\sigma_{ai}^2) = \frac{S_a^2}{\nu_a - 2}$（要求 $\nu_a > 2$）
* 自由度$\nu_{a0}$

$$
\sigma_{a 0}^{2}=\frac{\nu-2}{\nu} \frac{\sigma_{u}^{2}}{2 \sum_{i} p_{i} q_{i}}
$$

## &#9354;BayesB

* 前提：**多数标记与 QTL 无关，其真实效应为零**（$\sigma^2_{ai}$）。

**注意：**

* ==这在BayesA中不可能出现==
* <u>该方法对$S^2_a,ν_a$和$π$的 先验值较为敏感。</u>

$$
p\left(a_{i} \mid \sigma_{a i}^{2}\right)=N\left(0, \sigma_{a i}^{2}\right)
\\
\left\{\begin{aligned}
p\left(\sigma_{a i}^{2} \mid S_{a}, \nu_{a}\right) &= S_{a}\chi_{\nu_{a}}^{-2} &\text{with probability } 1-\pi \\
p\left(\sigma_{a i}^{2} \mid S_{a}, \nu_{a}\right) &= 0 &\text{with probability } \pi
\end{aligned}\right.
$$

## &#9355; BayesC

* 前提：**将有效应的标 记赋予”共同”方差$σ^2_{a0}$。**

* 最终(数据拟合后)$σ^2_{a0}$的取值几乎不依赖于先验设定，因此即**使先验设定有误，模型仍可能正确。**

$$
p\left(a_{i} \mid \delta_{i}\right)=\begin{cases} 
N\left(0, \sigma_{ai}^{2}\right) & \text{if } \delta_{i}=1 \\
0 & \text{otherwise}
\end{cases}
\\
p\left(\sigma_{a 0}^{2} \mid S_{a}, \nu_{a}\right)=S_{a} \chi_{\nu_{a}}^{-2}
\\
p\left(\delta_{i}=1\right)=1-\pi
$$

* 其中 $S_{a}$ 可设置为类似 $S_{a}^{2}=\sigma_{a 0}^{2} \nu_{a 0}$ 的形式

$$
\sigma_{a 0}^{2}=\frac{\sigma_{u}^{2}}{(1-\pi) 2 \sum p_{i} q_{i}}
$$

### &#9312;与性状关联的标记

* 使用 **Beta分布** 描述 $π$ 的不确定性。

> [!IMPORTANT]
>
> * BayesC的输出结果是$\delta_{i}$，即后验均值。
>
> * ==该值不会是非0 即1，而是介于两者之间，故**不能用于筛选”控制**。==

#### &#9332;判断显著性：贝叶斯因子

$$
BF=\frac{\frac{p(\text{SNP in the model} \mid data)}{p(\text{SNP not in the model} \mid data)}}{\frac{p(\text{SNP in the model})}{p(\text{SNP not in the model})}}
$$

本例中计算公式为：

$$
BF_{i}=\frac{(1-\pi)}{\pi} \frac{p\left(\delta_{i}=1 \mid \mathbf{y}\right)}{1 - p\left(\delta_{i}=1 \mid \mathbf{y}\right)}
$$

*  BF=3-20 为” 提示性”证据 

*  BF=20-150 为” 强”证据 

*  BF>150 为”极强”证据

*  注意：由于所有单核苷酸多态性(SNP)都是同时引入的，且先验分布已对其估计值进行了惩罚，因此==无需进行多重检验校正==。

## &#9356;Bayesian Lasso

* 前提：**将部分标记设置为极小值**。

$$
p(a_i|\lambda)=\frac{\lambda}{2 \sigma} \exp \left( -\frac{\lambda |a_i|}{\sigma} \right)
\\
p\left(a_{i}\mid \sigma_{ai}^{2}\right)=N\left(0, \sigma_{ai}^{2}\right)
\\
p\left(\sigma_{ai}^{2}\mid \lambda\right)=\frac{\lambda^{2}}{2}\exp\left(-\frac{\lambda^{2}}{2}\frac{\sigma_{ai}^{2}}{\sigma^{2}}\right)
$$

* 此处的$\lambda$与BLUP-SNP中的$\lambda$无关。

### &#9312;参数化

#### &#9332;设定$σ^2$=1

$$
Var(a_i|\lambda)=\frac{2}{λ^2}
\\
\frac{2}{\lambda^{2}}=\frac{\sigma_{u}^{2}}{2 \sum p_{i} q_{i}}
$$

#### &#9333;设定$\sigma^2=\sigma^2_e$

$$
\frac{2}{\lambda^{2}}=\frac{\sigma_{u}^{2}}{\sigma_{e}^{2} 2 \sum p_{i} q_{i}}
$$

# 五、VanRaden非线性方法

$$
\sigma_{a i}^{2}=\sigma_{a 0}^{2}\left(c^\left(\frac{|\widehat{a}_{i}|}{\text{sd}\left(\widehat{a}_{1},\dots,\widehat{a}_{n}\right)}-2\right)\right)
\\
c\in[1,1.25]
$$

- **标准化限制**：对 $\frac{|\widehat{a}_{i}|}{\text{sd}()}$ 设置上限为5（避免指数爆炸）
- **小数据集推荐**：使用 $c=1.12$ （平衡效率与稳定性）。

# 六、标记模型的可靠性

* $z_iz^′_i$的参数化选择——即便获得完全相同的育种值，==不同编码方式会导致可靠性估值差异==。

$$
Rel_i = 1 - \frac{\text{Var}(\widehat{u}_i)}{z_i z_i' \sigma_{a0}^2}
$$

- $Var(\widehat{u}_i)$：后验方差


$$
\text{Var}(a|y)=C^{aa}
\\
\text{Var}(u|y)=Z C^{aa} Z'
$$

- $C^{aa}$：后验协方差矩阵 
- 随后代入可靠性公式

$$

$$



